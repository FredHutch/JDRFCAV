---
title: "CAV Affymetric Cohort 2"
author: "Elizabeth Whalen"
date: "2/9/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read in expression data

Density plots show data have been RMA normalized, but there are a few libraries that have different densities. These unusual density samples will appear as outliers in the PCA plot later.

```{r readData}
# read in data
expData<-read.csv(file="/Users/ewhalen/Projects/CAV/2015 Mike Mason/Affy arrays Hessner lab/Cohort 2/CAV_IIandIII_All126wNormPla_PartekRMA_rawLog2Int_2016Dec09_forBRI.csv", row.names=1)
dim(expData)
# looks like log2 transformed
range(expData)

# look at density plots
# mainly looks normalized, but a few look different (batch effect?)
for (i in 1:ncol(expData))
{
	if (i==1)
		plot(density(expData[,i]), ylim=c(0,0.3))
	else
		lines(density(expData[,i]))
}
# need to get the correct barcodes to match to the design file
expBarcode<-unlist(lapply(strsplit(colnames(expData), "_"), function(x) {x[3]}))
length(unique(expBarcode))
# replace "." with "-"
newExpBC<-c()
for (i in 1:length(expBarcode))
{
	if (length(grep("\\.", expBarcode[i]))==1)
	{
		newBC<-paste(substr(expBarcode[i], 1, 6), "-", substr(expBarcode[i], 8, 10), sep="")
		newExpBC<-c(newExpBC, newBC)
	}
	else
		newExpBC<-c(newExpBC, expBarcode[i])
}
colnames(expData)<-newExpBC

```

## Read in design files

Read in both the sample sent file as well as the c-peptide outcome information.

```{r readDesign}
# now read in design file
hessDesign<-read.csv(file="/Users/ewhalen/Projects/CAV/2015 Mike Mason/Affy arrays Hessner lab/Cohort 2/20161122 Hessner ITN samples-ALL.csv")
hessDesign<-hessDesign[,1:8]
dim(hessDesign)
table(hessDesign$date.sent)
hessDesign$date.sent<-as.factor(hessDesign$date.sent)

hessDesign$cpeptide_visit_id<-paste(as.character(hessDesign$ITN_ID), as.character(hessDesign$visit_num), sep="_")

outcomeData<-read.csv(file="/Users/ewhalen/Projects/CAV/2015 Mike Mason/Cohort 2 Data/C-peptide decline calculations - Skinner/data/CAV-Cohort-2_outcomes_parameters_20170221a.csv")

sum(hessDesign$cpeptide_visit_id %in% outcomeData$cpeptide_visit_id)
#hessDesign[which(!(hessDesign$cpeptide_visit_id %in% outcomeData$cpeptide_visit_id)),]

hessDesign$study<-unlist(lapply(strsplit(as.character(hessDesign$ITN_ID), "_"), function(x) {x[1]}))
changeIndex<-which(hessDesign$visit_num=="1")
hessDesign$cpeptide_visit_id[changeIndex]<-paste(as.character(hessDesign$ITN_ID[changeIndex]), "-1", sep="_")
changeIndex<-which(hessDesign$visit_num=="0" & hessDesign$study=="T1DAL")
hessDesign$cpeptide_visit_id[changeIndex]<-paste(as.character(hessDesign$ITN_ID[changeIndex]), "-1", sep="_")
changeIndex<-which(hessDesign$visit_num=="0" & hessDesign$study=="START")
hessDesign$cpeptide_visit_id[changeIndex]<-paste(as.character(hessDesign$ITN_ID[changeIndex]), "-1", sep="_")

# now just have 2 that don't have matches
hessDesign[which(!(hessDesign$cpeptide_visit_id %in% outcomeData$cpeptide_visit_id)),]

# looking for visit 11 and 17 (month 6 and 24 or week 26 and 104)
# outcomeData labels month 6 and 24 as visit 19 and 42
#outcomeData[which("ABATE_007012"==outcomeData$participant_id),]
# yes these values appear to be mislabeled compared to other month 6 and 24 visits in ABATE
table(hessDesign$visit_num, hessDesign$month, hessDesign$study)
hessDesign$visit_num[which(hessDesign$ITN_ID=="ABATE_007012" & hessDesign$month==6 & hessDesign$visit_num==11)]<-19
hessDesign$visit_num[which(hessDesign$ITN_ID=="ABATE_007012" & hessDesign$month==24 & hessDesign$visit_num==17)]<-42

hessDesign$cpeptide_visit_id[which(hessDesign$cpeptide_visit_id=="ABATE_007012_11")]<-"ABATE_007012_19"
hessDesign$cpeptide_visit_id[which(hessDesign$cpeptide_visit_id=="ABATE_007012_17")]<-"ABATE_007012_42"
# now everything matches between hess design and outcome data
#hessDesign[which(!(hessDesign$cpeptide_visit_id %in% outcomeData$cpeptide_visit_id)),]


# now need to match between hess design and expression data
sum(newExpBC %in% hessDesign$barcode)
newExpBC[which(!(newExpBC %in% hessDesign$barcode))]

#hessDesign$barcode[grep("912448", hessDesign$barcode)]
hessDesign$barcode<-as.character(hessDesign$barcode)
hessDesign$barcode[which(hessDesign$barcode=="912448H02")]<-"912448-H02"

#hessDesign$barcode[grep("957644", hessDesign$barcode)]
hessDesign$barcode[which(hessDesign$barcode=="957644-H03")]<-"957644-H02"

#hessDesign$barcode[grep("954465", hessDesign$barcode)]
hessDesign$barcode[which(hessDesign$barcode=="954465-H04")]<-"954465-H03"

#hessDesign$barcode[grep("960050", hessDesign$barcode)]
hessDesign$barcode[which(hessDesign$barcode=="960050-H03")]<-"960050-H04"

hessDesign$barcode[grep("915371", hessDesign$barcode)]
hessDesign$barcode[which(hessDesign$barcode=="915371H02")]<-"915371-H02"
# okay now everything matches
all(newExpBC %in% hessDesign$barcode)

# there are some barcodes that are replicated
#sort(table(hessDesign$barcode))
names(which(table(hessDesign$barcode)==2))
# 2 of them are from month 0 - all 4 of these were sent over 2 dates
# date is important as a batch effect
#hessDesign[which(hessDesign$barcode=="916699-H02"),] # scan date was 11/4/16 (2nd batch)
#hessDesign[which(hessDesign$barcode=="920117-99K"),] # scan date was 11/4/16 (2nd batch)
#hessDesign[which(hessDesign$barcode=="921893-H05"),] # scan date was 11/3/16 (2nd batch)
#hessDesign[which(hessDesign$barcode=="932861-H02"),] # scan date was 11/4/16 (2nd batch)

# need to figure out which date sample we have - now subset to those samples
remIndex<-c(which(hessDesign$barcode=="916699-H02" & hessDesign$date.sent=="20160620"),
            which(hessDesign$barcode=="920117-99K" & hessDesign$date.sent=="20160620"),
            which(hessDesign$barcode=="921893-H05" & hessDesign$date.sent=="20160620"),
            which(hessDesign$barcode=="932861-H02" & hessDesign$date.sent=="20160620"))
hessDesignSub<-hessDesign[-remIndex,]

# subset hessDesign to match the expression data
hessDesignSub<-hessDesignSub[which(hessDesignSub$barcode %in% newExpBC),]
all(hessDesignSub$barcode == newExpBC)
hessDesignSub<-hessDesignSub[match(newExpBC, hessDesignSub$barcode),]
all(hessDesignSub$barcode==newExpBC)

# now we have matched the design to the expression data
# also need to match the outcome data
outcomeDataSub<-outcomeData[match(hessDesignSub$cpeptide_visit_id, outcomeData$cpeptide_visit_id),]
all(outcomeDataSub$cpeptide_visit_id==hessDesignSub$cpeptide_visit_id)

# now everything matches up
```

## PCA 

Create plots with all samples and then look at just baseline samples.

```{r PCA}
curPCA<-prcomp(t(expData), scale=TRUE, center=TRUE)

#summary(curPCA)
barplot((curPCA$sdev^2)/sum(curPCA$sdev^2), ylab="% Variance")
# most of the variability is in the first 2 PCs
barplot(((curPCA$sdev^2)/sum(curPCA$sdev^2))[1:10], ylab="% Variance", names.arg=paste("PC", 1:10, sep=""), las=2)

plot(x=curPCA$x[,1], y=curPCA$x[,2], xlab="PC1 (31.4%)", ylab="PC2 (9.7%)", pch=19)
curCol<-rep("black", nrow(hessDesignSub))
curCol[which(hessDesignSub$date.sent=="20160907")]<-"red"
table(curCol)
plot(x=curPCA$x[,1], y=curPCA$x[,2], xlab="PC1 (31.4%)", ylab="PC2 (9.7%)", pch=19, col=curCol)

# one looks like it's colored wrong (should be red?)
# both files say it was sent early (it's not a month 0, though so that's okay)
hessDesignSub[which(curPCA$x[,1] > 200 & curCol=="black" & curPCA$x[,2] > 50),]

# check what visit the outliers are
# one is month 0 - everything else will be removed when just looking at baseline
hessDesignSub[which(curPCA$x[,1] > 200),]
# PC1 = 354 and PC2 = -95.4
curPCA$x[which(hessDesignSub$barcode=="923866-H04"),1:2]

# subset 3 data sets to just visit 0 samples
keep0index<-which(hessDesignSub$month %in% c("0","day 1"))
length(keep0index)

expData0<-expData[,keep0index]
hessDesignSub0<-hessDesignSub[keep0index,]
outcomeDataSub0<-outcomeDataSub[keep0index,]
newExpBC0<-newExpBC[keep0index]

# yes, everything matches up
all(newExpBC0 == hessDesignSub0$barcode)
all(hessDesignSub0$cpeptide_visit_id==outcomeDataSub0$cpeptide_visit_id)

# make PCA of just the baseline visits
curPCA0<-prcomp(t(expData0), scale=TRUE, center=TRUE)
#summary(curPCA0)
barplot((curPCA0$sdev^2)/sum(curPCA0$sdev^2), ylab="% Variance")

curCol<-rep("black", nrow(hessDesignSub0))
curCol[which(hessDesignSub0$date.sent=="20160907")]<-"red"
table(curCol)
plot(x=curPCA0$x[,1], y=curPCA0$x[,2], xlab="PC1 (20.2%)", ylab="PC2 (13.8%)", pch=19, col=curCol, main="54 samples at baseline visit")

# remove one outlier - same as before
hessDesignSub0[which(curPCA0$x[,1] < -400),]
remIndex<-which(curPCA0$x[,1] < -400)

# remove one outlier
hessDesignSub0<-hessDesignSub0[-remIndex,]
expData0<-expData0[,-remIndex]
newExpBC0<-newExpBC0[-remIndex]
outcomeDataSub0<-outcomeDataSub0[-remIndex,]

all(newExpBC0 == hessDesignSub0$barcode)
all(hessDesignSub0$cpeptide_visit_id==outcomeDataSub0$cpeptide_visit_id)

curPCA0<-prcomp(t(expData0), scale=TRUE, center=TRUE)
#summary(curPCA0)
barplot((curPCA0$sdev^2)/sum(curPCA0$sdev^2), ylab="% Variance")

curCol<-rep("black", nrow(hessDesignSub0))
curCol[which(hessDesignSub0$date.sent=="20160907")]<-"red"
table(curCol)
plot(x=curPCA0$x[,1], y=curPCA0$x[,2], xlab="PC1 (16.2%)", ylab="PC2 (13.4%)", pch=19, col=curCol, main="Removed Outlier (53 samples at baseline visit)")

# make density plot again - should look similar now - good
for (i in 1:ncol(expData0))
{
	if (i==1)
		plot(density(expData0[,i]), ylim=c(0,0.3))
	else
		lines(density(expData0[,i]))
}
```

## Replicates
 
13 of the baseline samples are replicates. There are 32 samples from June 2016 and 21 samples from September 2016. Eventually will keep samples from September 2016 since there is a clear batch effect that needs to be corrected for between the 2 dates. For first analysis, will have a random effect in the model. 

```{r removeReps}
hessDesignSub0$ITN_ID<-as.character(hessDesignSub0$ITN_ID)
# no replicates from T1DAL
# 1 replicate in ABATE
# 12 replicates in START
table(hessDesignSub0$ITN_ID, hessDesignSub0$date.sent)
repIDs<-names(which(table(hessDesignSub0$ITN_ID)==2))
remCpepIDs<-hessDesignSub0$cpeptide_visit_id[which(hessDesignSub0$ITN_ID %in% repIDs & hessDesignSub0$date.sent=="20160620")]

```

## Analysis

Now the data have been subset to baseline visit only and one sample was removed as an outlier. That leaves 53 baseline samples for analysis to compare with c-peptide outcome. As shown in the previous PCA plot, date the samples were processed is an important batch effect that must be included in the model. Variables of interest are: 
1. date sent 
2. c-peptide as a slope
3. c-peptide as a difference 
4. age
5. gender
6. bmi
7. baseline c-peptide
8. hba1c

```{r firstModels}
library(limma)
# make sure variables are the right type
hessDesignSub0$date.sent<-as.factor(as.character(hessDesignSub0$date.sent))
# these are all right
class(outcomeDataSub0$bmi)
class(outcomeDataSub0$age_years)
class(outcomeDataSub0$sex)
class(outcomeDataSub0$cpep_model_decayrate)
class(outcomeDataSub0$cpep_model_absdiff_1year)
class(outcomeDataSub0$cpep_model_absdiff_2year)
class(outcomeDataSub0$cpep_auc2hr)
class(outcomeDataSub0$hba1c)

# bind all data together
hessDesignSub0$bmi<-outcomeDataSub0$bmi
hessDesignSub0$age_years<-outcomeDataSub0$age_years
hessDesignSub0$sex<-outcomeDataSub0$sex
hessDesignSub0$cpep_model_decayrate<-outcomeDataSub0$cpep_model_decayrate
hessDesignSub0$cpep_model_absdiff_1year<-outcomeDataSub0$cpep_model_absdiff_1year
hessDesignSub0$cpep_model_absdiff_2year<-outcomeDataSub0$cpep_model_absdiff_2year
hessDesignSub0$cpep_auc2hr<-outcomeDataSub0$cpep_auc2hr
hessDesignSub0$hba1c<-outcomeDataSub0$hba1c

# run models 4 ways:
# 1. all genes
# 2. filter genes (based on IQR - use the median value)
# 3. Marty's list 1
# 4. Marty's list 2

# cohort 1 code includes cohort 0 replicate testing and it looks like the largest CV was 0.213 so no genes are excluded based on replicate testing

# Marty's 2 lists
geneLists<-read.csv(file="/Users/ewhalen/Projects/CAV/2015 Mike Mason/Affy arrays Hessner lab/1374 and 359 lists.csv")
list1<-as.character(geneLists$Probeset.ID)[which(geneLists$II1374.4way.Venn.1.125.Fold.Filter.n_total..1374==1)]
length(list1)	# 1374
list2<-as.character(geneLists$Probeset.ID)[which(geneLists$II359.RF.ONEvs.Other3.on.12589n.Cxsect.Gini.n.359==1)]
length(list2)	# 359

# all are in the data
all(list1 %in% rownames(expData0))
all(list2 %in% rownames(expData0))

# need to filter genes
library(genefilter)
library(Biobase)
# cohort 1 data (to make feature data dataframe for eSet object)
affyData1<-read.csv(file="/Users/ewhalen/Projects/CAV/2015 Mike Mason/Affy arrays Hessner lab/Set65_CAVwROHC_PartekRMA_rawLog2Int_2016Feb12_wN35Anno.csv")
# feature data from cohort 1
featData<-affyData1[2:nrow(affyData1),1:8]
all(as.character(featData[,1])==rownames(expData0))
rownames(featData)<-as.character(featData[,1])
colnames(featData)<-as.character(as.matrix(affyData1[1,1:8]))
# sample (phenotype) data from design
phenData<-hessDesignSub0
rownames(phenData)<-colnames(expData0)
pData<-AnnotatedDataFrame(phenData)
fData<-AnnotatedDataFrame(featData)
# hgu133ab
affyEset<-ExpressionSet(assayData=as.matrix(expData0), phenoData=pData, featureData=fData, annotation="hgu133plus2")

affyEsetFilter<-nsFilter(affyEset, remove.dupEntrez=FALSE, var.func=IQR, var.cutoff=0.5)$eset
dim(affyEsetFilter)	# now have 21,168 genes to look at

matchIndex1<-match(list1, rownames(exprs(affyEset)))
sum(is.na(matchIndex1))
matchIndex2<-match(list2, rownames(exprs(affyEset)))
sum(is.na(matchIndex2))

affyEsetList1<-affyEset[matchIndex1,]
dim(affyEsetList1)
affyEsetList2<-affyEset[matchIndex2,]
dim(affyEsetList2)

# check overlap with filtered data (approximately 70% overlap)
sum(rownames(affyEsetList1) %in% rownames(affyEsetFilter)) # 921 out of 1374
sum(rownames(affyEsetList2) %in% rownames(affyEsetFilter)) # 253 out of 359

# run model on :
# 1. affyEset (all genes)
# 2. affyEsetFilter (filtered genes)
# 3. affyEsetList1 (Marty list 1)
# 4. affyEsetList2 (Marty list 2)

```

## Analysis on Full Data Set

Need to include age, baseline c-peptide, study and date sent in the model. Check to see if sex, bmi and hba1c are important (they are not). Need to include a random effect because have replicates in START and ABATE.

None of the c-peptide outcomes are significant (slope, difference year 1, or difference year 2). There were 54,675 features in this analysis on the full set of expression data.

```{r fullDataAnalysis}

# see what variables are important in full model with slope
# do I need to include:
# sex - not important (min p = 0.999) (cor = -0.1361007)
# bmi - not important (min p = 0.999) (cor = -0.1385237)
# hba1c - not important (min p = 0.999) (cor = NA (used -0.13))
mm1<-model.matrix(~cpep_model_decayrate + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm1[1:3,]
corfit1<-duplicateCorrelation(affyEset, mm1, block=hessDesignSub0$ITN_ID)
corfit1$consensus.correlation	# -0.1316442 
fit1<-lmFit(affyEset, design=mm1, block=hessDesignSub0$ITN_ID, correlation=corfit1$consensus.correlation)
fit1<-eBayes(fit1)

tt1<-topTable(fit1, coef=2, number=nrow(affyEset))
sum(tt1$adj.P.Val < 0.05) # 0
min(tt1$adj.P.Val) # 0.999

# full model with difference 1 year
mm2<-model.matrix(~cpep_model_absdiff_1year + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm2[1:3,]
corfit2<-duplicateCorrelation(affyEset, mm2, block=hessDesignSub0$ITN_ID)
corfit2$consensus.correlation	# -0.1392222 
fit2<-lmFit(affyEset, design=mm2, block=hessDesignSub0$ITN_ID, correlation=corfit2$consensus.correlation)
fit2<-eBayes(fit2)

tt2<-topTable(fit2, coef=2, number=nrow(affyEset))
sum(tt2$adj.P.Val < 0.05) # 0
min(tt2$adj.P.Val) # 0.738

# full model with difference 2 years
mm3<-model.matrix(~cpep_model_absdiff_2year + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm3[1:3,]
corfit3<-duplicateCorrelation(affyEset, mm3, block=hessDesignSub0$ITN_ID)
corfit3$consensus.correlation	# -0.1387713 
fit3<-lmFit(affyEset, design=mm3, block=hessDesignSub0$ITN_ID, correlation=corfit3$consensus.correlation)
fit3<-eBayes(fit3)

tt3<-topTable(fit3, coef=2, number=nrow(affyEset))
sum(tt3$adj.P.Val < 0.05) # 0
min(tt3$adj.P.Val) # 0.4815583

```

## Analysis on Filtered Data Set based on IQR

Need to include age, baseline c-peptide, study and date sent in the model. Check to see if sex, bmi and hba1c are important (they are not). Need to include a random effect because have replicates in START and ABATE.

None of the c-peptide outcomes are significant (slope, difference year 1, or difference year 2). There were 21,168 features in this analysis on the filtered set of expression data.

```{r filterDataAnalysis}

# see what variables are important in filtered model with slope
# do I need to include:
# sex - not important (min p = 0.9988) (cor = -0.1449332)
# bmi - not important (min p = 0.998) (cor = -0.1484644)
# hba1c - not important (min p = 0.999) (cor = NA (used -0.14))
mm4<-model.matrix(~cpep_model_decayrate + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm4[1:3,]
corfit4<-duplicateCorrelation(affyEsetFilter, mm4, block=hessDesignSub0$ITN_ID)
corfit4$consensus.correlation	# -0.1413368 
fit4<-lmFit(affyEsetFilter, design=mm4, block=hessDesignSub0$ITN_ID, correlation=corfit4$consensus.correlation)
fit4<-eBayes(fit4)

tt4<-topTable(fit4, coef=2, number=nrow(affyEsetFilter))
sum(tt4$adj.P.Val < 0.05) # 0
min(tt4$adj.P.Val) # 0.999

# filtered data full model with difference 1 year
mm5<-model.matrix(~cpep_model_absdiff_1year + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm5[1:3,]
corfit5<-duplicateCorrelation(affyEsetFilter, mm5, block=hessDesignSub0$ITN_ID)
corfit5$consensus.correlation	# -0.1510525 
fit5<-lmFit(affyEsetFilter, design=mm5, block=hessDesignSub0$ITN_ID, correlation=corfit5$consensus.correlation)
fit5<-eBayes(fit5)

tt5<-topTable(fit5, coef=2, number=nrow(affyEsetFilter))
sum(tt5$adj.P.Val < 0.05) # 0
min(tt5$adj.P.Val) # 0.915

# filtered data full model with difference 2 years
mm6<-model.matrix(~cpep_model_absdiff_2year + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm6[1:3,]
corfit6<-duplicateCorrelation(affyEsetFilter, mm6, block=hessDesignSub0$ITN_ID)
corfit6$consensus.correlation	# -0.1509313 
fit6<-lmFit(affyEsetFilter, design=mm6, block=hessDesignSub0$ITN_ID, correlation=corfit6$consensus.correlation)
fit6<-eBayes(fit6)

tt6<-topTable(fit6, coef=2, number=nrow(affyEsetFilter))
sum(tt6$adj.P.Val < 0.05) # 0
min(tt6$adj.P.Val) # 0.926

```


## Analysis on Marty List 1 Data Set

Need to include age, baseline c-peptide, study and date sent in the model. Check to see if sex, bmi and hba1c are important (they are not). Need to include a random effect because have replicates in START and ABATE.

None of the c-peptide outcomes are significant (slope, difference year 1, or difference year 2). There were 1,374 features in this analysis on Marty's list 1 of expression data. 

```{r list1DataAnalysis}

# see what variables are important in list1 model with slope
# do I need to include:
# sex - not important (min p = 0.955328) (cor = -0.198065)
# bmi - not important (min p = 0.9964136) (cor = -0.1962077)
# hba1c - not important (min p = 0.9848483) (cor = NA (used -0.19))
mm7<-model.matrix(~cpep_model_decayrate + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm7[1:3,]
corfit7<-duplicateCorrelation(affyEsetList1, mm7, block=hessDesignSub0$ITN_ID)
corfit7$consensus.correlation	# -0.198065 
fit7<-lmFit(affyEsetList1, design=mm7, block=hessDesignSub0$ITN_ID, correlation=corfit7$consensus.correlation)
fit7<-eBayes(fit7)

tt7<-topTable(fit7, coef=2, number=nrow(affyEsetList1))
sum(tt7$adj.P.Val < 0.05) # 0
min(tt7$adj.P.Val) # 0.6554943

# list 1 data full model with difference 1 year
mm8<-model.matrix(~cpep_model_absdiff_1year + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm8[1:3,]
corfit8<-duplicateCorrelation(affyEsetList1, mm8, block=hessDesignSub0$ITN_ID)
corfit8$consensus.correlation	# -0.2197446 
fit8<-lmFit(affyEsetList1, design=mm8, block=hessDesignSub0$ITN_ID, correlation=corfit8$consensus.correlation)
fit8<-eBayes(fit5)

tt8<-topTable(fit8, coef=2, number=nrow(affyEsetList1))
sum(tt8$adj.P.Val < 0.05) # 0
min(tt8$adj.P.Val) # 0.915

# list 1 data full model with difference 2 years
mm9<-model.matrix(~cpep_model_absdiff_2year + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm9[1:3,]
corfit9<-duplicateCorrelation(affyEsetList1, mm9, block=hessDesignSub0$ITN_ID)
corfit9$consensus.correlation	# -0.1509313 
fit9<-lmFit(affyEsetList1, design=mm9, block=hessDesignSub0$ITN_ID, correlation=corfit9$consensus.correlation)
fit9<-eBayes(fit9)

tt9<-topTable(fit9, coef=2, number=nrow(affyEsetList1))
sum(tt9$adj.P.Val < 0.05) # 0
min(tt9$adj.P.Val) # 0.6602313

```





## Analysis on Marty List 2 Data Set

 There were 359 features in this analysis on Marty's list 2 of expression data. 

```{r list2DataAnalysis}

# see what variables are important in list1 model with slope
# do I need to include:
# sex - not important (min p = 0.6877993) (cor = -0.152145)
# bmi - not important (min p = 0.9947886) (cor = -0.1422165)
# hba1c - not important (min p = 0.9749104) (cor = NA (used -0.14))
mm10<-model.matrix(~cpep_model_decayrate + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm10[1:3,]
corfit10<-duplicateCorrelation(affyEsetList2, mm10, block=hessDesignSub0$ITN_ID)
corfit10$consensus.correlation	# -0.1426605 
fit10<-lmFit(affyEsetList2, design=mm10, block=hessDesignSub0$ITN_ID, correlation=corfit10$consensus.correlation)
fit10<-eBayes(fit10)

tt10<-topTable(fit10, coef=2, number=nrow(affyEsetList2))
sum(tt10$adj.P.Val < 0.05) # 0
min(tt10$adj.P.Val) # 0.4265299

# list 2 data full model with difference 1 year
mm11<-model.matrix(~cpep_model_absdiff_1year + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm11[1:3,]
corfit11<-duplicateCorrelation(affyEsetList2, mm11, block=hessDesignSub0$ITN_ID)
corfit11$consensus.correlation	# -0.1577856 
fit11<-lmFit(affyEsetList2, design=mm11, block=hessDesignSub0$ITN_ID, correlation=corfit11$consensus.correlation)
fit11<-eBayes(fit11)

tt11<-topTable(fit11, coef=2, number=nrow(affyEsetList2))
sum(tt11$adj.P.Val < 0.05) # 0
min(tt11$adj.P.Val) # 0.8067615

# list 2 data full model with difference 2 years
mm12<-model.matrix(~cpep_model_absdiff_2year + age_years + cpep_auc2hr + study + date.sent, data=hessDesignSub0)
mm12[1:3,]
corfit12<-duplicateCorrelation(affyEsetList2, mm12, block=hessDesignSub0$ITN_ID)
corfit12$consensus.correlation	# -0.1608696 
fit12<-lmFit(affyEsetList2, design=mm12, block=hessDesignSub0$ITN_ID, correlation=corfit12$consensus.correlation)
fit12<-eBayes(fit12)

tt12<-topTable(fit12, coef=2, number=nrow(affyEsetList2))
sum(tt12$adj.P.Val < 0.05) # 0
min(tt12$adj.P.Val) # 0.7191123

```

## Write out data to file

```{r writeOutData}

# need to write out the 4 sets of genes, but need to remove date sent first
rbeMM<-model.matrix(~as.factor(date.sent), data=hessDesignSub0)
keepMM<-model.matrix(~age_years+study, data=hessDesignSub0)
affyEsetNoDate<-removeBatchEffect(affyEset, covariates=rbeMM[,-1], design=keepMM)
# make PCA plot
curPCA0ND<-prcomp(t(affyEsetNoDate), scale=TRUE, center=TRUE)
#summary(curPCA0ND)
barplot((curPCA0ND$sdev^2)/sum(curPCA0ND$sdev^2), ylab="% Variance")

curCol<-rep("black", nrow(hessDesignSub0))
curCol[which(hessDesignSub0$date.sent=="20160907")]<-"red"
table(curCol)
# batch effect of date is removed
plot(x=curPCA0ND$x[,1], y=curPCA0ND$x[,2], xlab="PC1 (15.4%)", ylab="PC2 (10.1%)", pch=19, col=curCol, main="Removed Outlier (53 samples at baseline visit)\nremoved date batch effect")

# look at correlation of those that are replicates
library(corrplot)
col1 <- colorRampPalette(c("blue","white", "red"))
corrplot(cor(affyEsetNoDate), order="hclust", col=col1(100))
allCor<-cor(affyEsetNoDate)
# the correlations are all very high
min(allCor)
# look at the correlation of replicates in particular
repNames<-names(which(table(hessDesignSub0$ITN_ID)==2))
repCors<-c()
for (i in 1:length(repNames))
{
  curIndex<-which(hessDesignSub0$ITN_ID==repNames[i])
  repCors<-c(repCors, cor(affyEsetNoDate[,curIndex[1]], affyEsetNoDate[,curIndex[2]]))
}
names(repCors)<-repNames
range(repCors)
# conclusion: the correlation values are all very high, but so are correlation values from different individuals

# make 3 other sets
affyEsetNoDateFilter<-affyEsetNoDate[match(rownames(affyEsetFilter), rownames(affyEsetNoDate)),]
all(rownames(affyEsetNoDateFilter)==rownames(affyEsetFilter))

affyEsetNoDateList1<-affyEsetNoDate[match(rownames(affyEsetList1), rownames(affyEsetNoDate)),]
all(rownames(affyEsetNoDateList1)==rownames(affyEsetList1))

affyEsetNoDateList2<-affyEsetNoDate[match(rownames(affyEsetList2), rownames(affyEsetNoDate)),]
all(rownames(affyEsetNoDateList2)==rownames(affyEsetList2))

# need to remove replicates
remIndex<-which(hessDesignSub0$ITN_ID %in% repIDs & hessDesignSub0$date.sent=="20160620")
affyEsetNoDate<-affyEsetNoDate[,-remIndex]
affyEsetNoDateFilter<-affyEsetNoDateFilter[,-remIndex]
affyEsetNoDateList1<-affyEsetNoDateList1[,-remIndex]
affyEsetNoDateList2<-affyEsetNoDateList2[,-remIndex]

hessDesignSub0r<-hessDesignSub0[-remIndex,]

# write 4 sets out to file
write.csv(affyEsetNoDate, file="/Users/ewhalen/Projects/CAV/Results/Cohort2/Affy/fullAffymetrixData_RemovedDateSent.csv")
write.csv(affyEsetNoDateFilter, file="/Users/ewhalen/Projects/CAV/Results/Cohort2/Affy/filteredAffymetrixData_RemovedDateSent.csv")
write.csv(affyEsetNoDateList1, file="/Users/ewhalen/Projects/CAV/Results/Cohort2/Affy/list1AffymetrixData_RemovedDateSent.csv")
write.csv(affyEsetNoDateList2, file="/Users/ewhalen/Projects/CAV/Results/Cohort2/Affy/list2AffymetrixData_RemovedDateSent.csv")

# write out design file
write.csv(hessDesignSub0r, file="/Users/ewhalen/Projects/CAV/Results/Cohort2/Affy/designAtBaseline.csv", row.names=FALSE)

```

## Summary

The results all 4 sets of data (full data set, filtered data set, Marty's lists 1 and 2) show that date sent is the most important source of varability in the data. Age in years and study are also significantly related to expression in some genes. No significant genes were found for bmi, hba1c, sex, cpeptide slope, cpeptide difference or c-peptide at baseline.
